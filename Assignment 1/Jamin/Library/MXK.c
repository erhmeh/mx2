#include "MXK.h"
#include "ISR.h"
#include "LED.h"

Button	TestButton;
Button	DIPSwitch;
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
void            MXK_InitTestButton()
{
    Port_SetPinType(&PortB, TEST_BUTTON, eTypeInput);
}
UINT8           MXK_TestButton()
{
    return Port_GetPin(&PortB, TEST_BUTTON);
}
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
void            MXK_InitDIPSwitch()
{
    Port_SetQuadType(&PortD, DIP, eTypeInput);
}
UINT8           MXK_DIPSwitch()
{
    return Port_GetQuad(&PortD, DIP);
}
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
#define SETTLE_TIME 10//us
eMXK_BusState Bus_State = eMXK_Idle;
volatile Function lQueue;
void MXK_Init(void)
{
    Bus_State = eMXK_Idle;
    lQueue = (Function)0;
    ////////////////////////////////////////////////////////////////////////////
    Port_Init(&PortA, ePortA);
    Port_Init(&PortB, ePortB);  
    Port_Init(&PortC, ePortC);  
    Port_Init(&PortD, ePortD);  
    Port_Init(&PortE, ePortE);  
    Port_Init(&PortF, ePortF);  
    Port_Init(&PortG, ePortG);  
    ////////////////////////////////////////////////////////////////////////////
    Port_SetPinType	(&PortF, USB_STATE, eTypeInput);
    Port_SetQuadType	(&PortB, ISR,	    eTypeInput);
    Port_SetPinType	(&PortF, IO_READ,   eTypeOutput);
    Port_SetType	(&PortG,	    eTypeOutput);
    ////////////////////////////////////////////////////////////////////////////
    Port_SetPin(&PortG, IO_CS,	0);
    Port_SetPin(&PortF, IO_READ,1);
    ////////////////////////////////////////////////////////////////////////////
    //Configures the LED pins to be outputs
    LED_Init(eLED1);
    LED_Init(eLED2);
    ////////////////////////////////////////////////////////////////////////////
    PIR1 = 0;
    PIR2 = 0;
    PIR3 = 0;
    ////////////////////////////////////////////////////////////////////////////
    OSCTUNEbits.INTSRC	=   1;
    OSCTUNEbits.PLLEN	=   1;
    ////////////////////////////////////////////////////////////////////////////
    //Wait for PLL to lock
    delay_ms(100);
    ////////////////////////////////////////////////////////////////////////////
    RCONbits.IPEN = 1; //interrupt priority enabled 
}
void            MXK_Poll(void)
{
    ////////////////////////////////////////////////////////////////////////////
    //Update the button structure, this includes de-bouncing and event raising
    Button_Poll(&TestButton, 1);
    Button_Poll(&DIPSwitch, 1);
}
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
bool MXK_BlockSwitchTo(eMXK_Module pModule)
{
    //Add timer functionality to make sure that it doesn't get stuck
    UINT8 CUR = 0xF & PORTG;
    ////////////////////////////////////////////////////////////////////////////
    while (Bus_State == eMXK_Busy);
    Bus_State = eMXK_Busy;

    if (CUR != pModule)
    {
	PORTG &= ~(0xF);
	PORTG |= pModule;
	
	//Modules might require settling time
	delay_us(SETTLE_TIME);
    }
    return true;
}
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
bool MXK_SwitchTo(eMXK_Module pModule)
{
    UINT8 CUR = 0xF & PORTG;
    ////////////////////////////////////////////////////////////////////////////
    if (Bus_State == eMXK_Busy)
	return 0;
    
    Bus_State = eMXK_Busy;
    ////////////////////////////////////////////////////////////////////////////
    if (CUR != pModule)
    {
	PORTG &= ~(0xF);
	PORTG |= pModule;
	
	//Modules might require settling time
	delay_us(SETTLE_TIME);
    }
    return 1;
}

////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
bool MXK_Release()
{
    Bus_State = eMXK_Idle;
    
    if (lQueue != 0)
	return true;
   
    return false;
}
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
void MXK_Queue(Function pCallback)
{
    lQueue = pCallback;
}
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
void MXK_Dequeue()
{
    if (lQueue)
	lQueue();
    lQueue = 0;
}
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
UINT8 MXK_ReadIO()
{
    return PORTE;
}
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
UINT8 MXK_ReadISR()
{
    return PORTB & 0xF;
}
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
