#include "Timer2.h"

void Timer2_Clear()
{
    PIR1bits.TMR2IF	=   0;
    PIE1bits.TMR2IE	=   0;
    IPR1bits.TMR2IP	=   0;
}

void Timer2_Init(UINT32 pFrequency)
{
    static const UINT8	PRESCALE[] = {1, 4, 16};
    static UINT8	INDEX = 0;
    static UINT8	PRE = 0;
    static UINT32	DIV = 0;
    ////////////////////////////////////////////////////////////////////////////
    UINT32 pCPUClock = CPUCLOCK;
    UINT32 DIVIDE, RDIV;
    ////////////////////////////////////////////////////////////////////////////
    pFrequency *= 2;
    ////////////////////////////////////////////////////////////////////////////
    //Divides the clock by 4
    pCPUClock   /= 4;
    DIVIDE      = pCPUClock / pFrequency;
    ////////////////////////////////////////////////////////////////////////////
    //Mask out the various sections of divide
    while ((DIVIDE/PRESCALE[INDEX]) > 255)
    {
        RDIV = 0;
        INDEX ++;
        if (INDEX >= 3)
            break;
    }
    ////////////////////////////////////////////////////////////////////////////
    //Setup the TCON pre-scale
    ////////////////////////////////////////////////////////////////////////////
    T2CONbits.T2CKPS = INDEX;
    ////////////////////////////////////////////////////////////////////////////
    //Start the timer
    T2CONbits.TMR2ON = 1;
    ////////////////////////////////////////////////////////////////////////////
    //Clear flags, disable interrupts
    ////////////////////////////////////////////////////////////////////////////
    Timer2_Clear();
    PRE = PRESCALE[INDEX];
    DIV = (DIVIDE-1);
    ////////////////////////////////////////////////////////////////////////////
    INDEX = DIV/PRE;
    PR2 = INDEX;
    ////////////////////////////////////////////////////////////////////////////
}
