#include "Button.h"

#include <stdbool.h>
#include "Types.h"
#include "Port.h"

////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
extern Port PortA, PortB, PortC, PortD, PortE, PortF, PortG;
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
void Button_Init(ButtonPtr pInput, UINT16 pThreshold, 
	Button_InitIO pInitIO, Button_State pGetState, EventFunction pFunction)
{
    ifnull(pInput)
	return;
    ifnull(pInitIO)
	return;
    ifnull(pGetState)
	return;
    ifnull(pFunction)
	return;
    
    if(pThreshold == 0)
	pThreshold = 1;
    
    //Setup local varialbes.
    pInput->mState	= 0;
    pInput->mCount	= 0;
    pInput->mThreshold	= pThreshold;
    pInput->mFunction	= pFunction;
    pInput->mGetState	= pGetState;
    
    //Intialise the  button IO
    pInitIO();

}
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
//Button_Poll:
// 	pButton is a pointer to the button to initialize.
//	pIncrement time that has elapsed since the last update.
//	Pin is the current pin state.
//Output: 
//	bTRUE if successful.
//Conds:  
//	None.
bool Button_Poll(ButtonPtr pButton, UINT8 pIncrement)
{
    UINT8 Pin = pButton->mGetState();
    
    if (pButton->mState == Pin)
    {
	//If the increment is greater than the ongoing count set
	// mCount to zero as it cannot go negative
      if(pIncrement > pButton->mCount)
	pButton->mCount =   0;
      else
	pButton->mCount -=  pIncrement;
    }

    //Ensures that the increment won't cause overflow
    else if(pButton->mCount + pIncrement > pButton->mCount)
    {
	//Increment positively because pin is starting to weight its opposite state
      pButton->mCount += pIncrement;
      if(pButton->mCount >= pButton->mThreshold)
      {
	//The mCount has reached its  threshold value and therefore 
	pButton->mState = Pin;
	pButton->mCount = 0;

	//Run the function assigned in the initialization on rising edge of de-bounced button press
	pButton->mFunction(Pin);
	return true;
      }
    }
    return false;
}