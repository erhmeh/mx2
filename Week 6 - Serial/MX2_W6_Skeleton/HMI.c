/* 
 * File:   HMI.h
 * Author: User
 *
 * Created on 25 October 2016, 2:33 PM
 */
#include "HMI.h"
#include "SPI.h"
#include "LCD.h"
#include "Events.h"
#include "Port.h"
#include "Functions.h"
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
HMI HMIBoard;
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////

void            HMI_InitButtons()
{
    TRISE = 0xFC;
}
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
UINT8           HMI_LeftSwitch()
{
    return Port_GetPin(&PortE, HMI_LEFT);
}
////////////////////////////////////////////////////////////////////////////////
UINT8           HMI_RightSwitch()
{
    return Port_GetPin(&PortE, HMI_RIGHT);
}
////////////////////////////////////////////////////////////////////////////////
UINT8           HMI_UpSwitch()
{
    return Port_GetPin(&PortE, HMI_UP);
}
////////////////////////////////////////////////////////////////////////////////
UINT8           HMI_DownSwitch()
{
    return Port_GetPin(&PortE, HMI_DOWN);
}
////////////////////////////////////////////////////////////////////////////////
UINT8		HMI_DIPSwitch()
{
    return Port_GetQuad(&PortE, HMI_DIP);
}
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
void OutSeg(UINT8 pInput, UINT8 pSegment)
{
    ////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////
    static UINT8 cur;
    volatile UINT8 out;
    static UINT8 segset;
    static UINT8 a;
    
#ifdef HMI_LOOPING_FIFO
    static UINT16 index;
    /////v///////////////////////////////////////////////////////////////////////
    pSegment <<= 3;
    cur = pInput;
    for (a = 0; a<8; a++)
    {
	segset = (cur & 1)<<6;
	out = pSegment | a | segset;
	cur >>= 1;
	index = a + pSegment;
	
	*(HMIBoard.Buffer + index) = out;
    }
    
    //Kick-start process
    if (SPI1.mBusy == false)
	SPI_SetFlags(&SPI1);
#else
    ////////////////////////////////////////////////////////////////////////////
    if (pSegment <= 8)
    {
        cur = pInput;
        for (a = 0u; a<8u; a++)
        {
            segset = (cur & 1u)<<6u;
            out = (pSegment<<3u) | a | segset;
            cur >>= 1;
            SPI_Send(&SPI1, out);
	    
#ifdef HMI_RENDER_DELAYED
	    delay_us(HMI_RENDER_DELAY);
#endif
        }
	SPI_Send(&SPI1, 0);
    }
#endif
    ////////////////////////////////////////////////////////////////////////////
}
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
void    HMI_Init()
{
    //Initailise buttons
    Button_Init(&(HMIBoard.mDIP),   DEBOUNCE, 
		HMI_InitButtons, HMI_DIPSwitch,	    Event_NULL);
    
    Button_Init(&(HMIBoard.mLeft),  DEBOUNCE, 
		HMI_InitButtons, HMI_LeftSwitch,    Event_NULL);
    
    Button_Init(&(HMIBoard.mRight), DEBOUNCE, 
		HMI_InitButtons, HMI_RightSwitch,   Event_NULL);
    
    Button_Init(&(HMIBoard.mUp),    DEBOUNCE, 
		HMI_InitButtons, HMI_UpSwitch,	    Event_NULL);
    
    Button_Init(&(HMIBoard.mDown),  DEBOUNCE, 
		HMI_InitButtons, HMI_DownSwitch,    Event_NULL);
    
    ////////////////////////////////////////////////////////////////////////////
    //Initialize the SPI port used to drive all of the LEDs on the HMI board
    SPI_Init(DEFAULT_SPI, eSPI1, SevenSegmentMode);
    SPI_MinSpeed(&SPI1);
    ////////////////////////////////////////////////////////////////////////////
    for (UINT16 in = 0; in<sizeof(HMIBoard.Bytes); in++)
        HMIBoard.Bytes[in] = 0;
    ////////////////////////////////////////////////////////////////////////////
    
#ifdef HMI_LOOPING_FIFO
    HMIBoard.Buffer = SPI1.mOutputBuffer;
    FIFO_Register(&SPI1.mOutputFIFO, HMIBoard.Buffer, sizeof(SPI1.mOutputBuffer));
#endif
}
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
void    HMI_Render()
{
    ////////////////////////////////////////////////////////////////////////////
    for (UINT16 a = 0; a < sizeof(HMIBoard.Bytes); a++)
	OutSeg(HMIBoard.Bytes[a], a);
    ////////////////////////////////////////////////////////////////////////////
}
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
void    HMI_GRender()
{
    ////////////////////////////////////////////////////////////////////////////
    static UINT16 a = 0;
    ////////////////////////////////////////////////////////////////////////////
    OutSeg(HMIBoard.Bytes[a], a);
    ////////////////////////////////////////////////////////////////////////////
    a++;
    ////////////////////////////////////////////////////////////////////////////
    if (a >= sizeof(HMI))
        a=0;
    ////////////////////////////////////////////////////////////////////////////
}
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
void    HMI_SetLeft(UINT8 pValue)
{
    HMIBoard.LEFTLED = pValue;
}
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
void    HMI_SetRight(UINT8 pValue)
{
    HMIBoard.RIGHTLED = pValue;
}
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
void    HMI_SetUp(UINT8 pValue)
{
    HMIBoard.UPLED = pValue;
}
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
void    HMI_SetDown(UINT8 pValue)
{
    HMIBoard.DOWNLED = pValue;
}
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
void    HMI_SetButton(UINT8 pValue)
{
    const UINT8 reindex[] = {0, 2, 1, 3};
    UINT8 v = 0b00010001;
    pValue &= 3;
    v = v << reindex[pValue];
    v = v >> 4;
    v = v & 0x0F;
    HMIBoard.pButton = v;
}
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
void    HMI_SetButtons(UINT8 pValue)
{
    pValue &= 0xF;
    HMIBoard.pButton = pValue;
}
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
void    HMI_SetBar(UINT8 pValue)
{
    HMIBoard.pBarGraph = pValue;
}
UINT8	HMI_GetBar()
{
    return HMIBoard.pBarGraph;
}
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
void    HMI_SetBargraph(UINT8 pValue)
{
    HMIBoard.pBarGraph = (0xFF >> (8-pValue));
}
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
void    HMI_SetNumber(int pInput)
{
    itos(pInput, HMIBoard.pSevenSegment);
    HMI_SetSegments(HMIBoard.pSevenSegment);
}
void    HMI_SetSegments(str pString)
{
    UINT16 in=0;
    while(*pString)
    {
        HMIBoard.pSevenSegment[in] = ToSegment(*pString);
        
        if (HMIBoard.pSevenSegment[in] == eDot)
        {
            in--;
            HMIBoard.pSevenSegment[in] |= eDot;
        }
        
        pString++;
        in++;
        if (in>=6)
            break;
    }
    while(in<6)
    {
        HMIBoard.pSevenSegment[in] = 0;
        in++;
    }
}
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
void    HMI_Poll()
{
    TRISE = 0xFC;
    Button_Poll(&(HMIBoard.mDIP),   1);
    Button_Poll(&(HMIBoard.mLeft),  1);
    Button_Poll(&(HMIBoard.mRight), 1);
    Button_Poll(&(HMIBoard.mUp),    1);
    Button_Poll(&(HMIBoard.mDown),  1);
}